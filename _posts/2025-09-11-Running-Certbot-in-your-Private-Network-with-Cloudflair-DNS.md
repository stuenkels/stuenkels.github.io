---
layout: post
---

--- 

## Table of contents
- [Table of contents](#table-of-contents)
- [Overview](#overview)
- [ Installing Certbot](#installing-certbot)
- [Create Scripts](#create-scripts)

### [Overview](#overview)
Certbot is a wonderful tool for automatic the process of SSL certificate requests and renewal. On my Proxmox host I am running an Nginx reverse proxy to provide secure https access to the management console. On a public server running nginx, it is trivial to install Certbot's nginx plugin and generate a certificate, however that method works by checking public DNS records and matching the local system's IP address to the DNS A or AAAA record. This works great for public services, however I do not have any public IPv4 addresses and run my managment services in the private 10.99.0.0/24 subnet. This guide will go over how certificates can still be automitcally generated, even on systems which do not have a public IP.

---

### [Installing Certbot](installing-certbot)
Certbot can be installed through the debian apt repository using the command 

```sudo apt install certbot python3-certbot-nginx```
If you are running on a public server using Nginx, all you have to do is run the following command:

```sudo certbot --nginx -d www.example.com```

Once certbot is installed we can move on to settup up our manual DNS challange  scripts which will create a DNS record on our Cloudflair account automitcally using an API key.

---

### [Create Scripts](create-scripts)
Certbot can use two scripts for manual DNS challanges, `manual-auth-hook` and `manual-cleanup-hook`. The auth-hook will reach out to Cloudflair's API and create the challange record, while the cleanup-hook deletes the record. You will need a Cloudflair API key that has access to DNS. This can be generated by loggin in, selecting Profile -> API Tokens -> Create Token. From the list of API token templates, select the Edit zone DNS option. Be sure to write down the token, as Cloudflare will not display it again. 

On your server navigate to the directory you want your scripts to be stored in. I will be using `/usr/local/sbin/`, as this direcotry is already in my path. Enter the directory:

```cd /usr/local/sbin/```
Create the bash script file `manual-auth-hook.sh` and `manual-cleanup-hook.sh`:

```sudo touch ./manual-auth-hook.sh
sudo touch ./manual-cleanup-hook.sh```


